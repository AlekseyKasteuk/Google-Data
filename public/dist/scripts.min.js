var app=angular.module("GoogleData",["ui.router","ui.tinymce","ngMaterial","ngMessages","ngFileUpload","ngImgCrop","ui.calendar"]);app.config(["$httpProvider","$urlRouterProvider","$stateProvider","$locationProvider","$mdIconProvider","$mdThemingProvider",function(e,t,a,r,l,o){t.otherwise("/"),a.state("login",{url:"/login",templateUrl:"application/states/login/login.html",controller:"LoginCtrl"}).state("app",{url:"/",templateUrl:"application/states/app/app.html",controller:"AppCtrl"}).state("app.profile",{url:"profile?account",templateUrl:"application/states/app/profile/profile.html",controller:"ProfileCtrl"}).state("app.messages",{url:"messages?labels",templateUrl:"application/states/app/messages/messages.html",controller:"MessagesCtrl"}).state("app.message",{url:"messages/:id",templateUrl:"application/states/app/messages/id/message.html",controller:"MessageCtrl"}).state("app.calendar",{url:"calendar",templateUrl:"application/states/app/calendar/calendar.html",controller:"CalendarCtrl"}),o.theme("default").primaryPalette("blue").accentPalette("indigo")}]),app.run(["$rootScope","$state","$stateParams","authService",function(e,t,a,r){e.getRange=function(e,t){return t=t?t:{},"birth year"==e?_.range(moment().year(),moment().year()-120):"birth month"==e?moment.months():"birth date"==e&&t.year&&t.month?_.range(1,moment().year(t.year).month(t.month).daysInMonth()+1):[]},e.$on("$stateChangeStart",function(a,l,o){r.checkAuth().success(function(a){e.authorizedUser=a,"login"==l.name&&t.go("app")}).error(function(){e.authorizedUser=void 0,"login"!=l.name&&t.go("login")})})}]);
app.filter("html",["$sce",function(t){return function(n){return t.trustAsHtml(n)}}]);
app.filter("pagination",[function(){return function(n,i,t){return t--,n.slice(i*t,i*t+i)}}]);
app.factory("authService",["$http",function(t){return{login:function(n){return t.post("/login",n)},logout:function(){return t.post("/logout")},checkAuth:function(){return t.get("/auth/check")},createNewAccount:function(n){return t.post("/create/account",n)}}}]);
app.factory("calendarService",["$http",function(t){return{getCalendars:function(e,n){return console.log(e,n),t.get("/calendar/list?start="+e+"&end="+n)}}}]);
app.factory("messageService",["$http",function(e){return{getMessage:function(t){return e.get("/google/thread/"+t)},toggleThreadLabel:function(t){return e.put("/thread/label/toggle",{data:t})}}}]);
app.factory("messagesService",["$http",function(e){return{getThreads:function(t,s){return e.post("/google/message/threads",{labels:t,pageToken:s})},sendEmail:function(t){return e.post("google/message/send",t)},removeThreads:function(t){return e.post("/thread/list/delete",t)}}}]);
app.factory("profileService",["$http",function(e){return{getProfileInfo:function(t){return e.get("/user/info?profile="+t)},updateCurrentGoogleAccount:function(t){return console.log(t),e.put("/google/update",{id:t})},updateInternalProfile:function(t){return e.put("/profile/internal/update",t)}}}]);
app.factory("socket",["$rootScope",function(n){var o=io.connect();return{on:function(t,c){o.on(t,function(){var t=arguments;n.$apply(function(){c.apply(o,t)})})},emit:function(t,c,p){o.emit(t,c,function(){var t=arguments;n.$apply(function(){p&&p.apply(o,t)})})}}}]);
app.factory("uploadFileService",["Upload",function(o){return function(t,a,l){return console.log(o.dataUrltoBlob(t,l).toString()),o.upload({url:a,method:"POST",data:{message:"HELLO WORLD!"},file:o.dataUrltoBlob(t,l)})}}]);
app.directive("calendarListItem",[function(){return{restrict:"AE",scope:{calendarListItem:"=",calendarSection:"@"},templateUrl:"/application/directives/calendar_list_item/calendar_list_item.html"}}]);
app.directive("messageTypeChoice",[function(){return{restrict:"A",templateUrl:"/application/directives/message_type_choice/message_type_choice.html"}}]);
app.directive("profileCard",["profileService","$timeout","$stateParams",function(e,i,r){return{restrict:"A",scope:{},templateUrl:"/application/directives/profile_card/profile_card.html",link:function(e,t){var a=r.account?r.account:"internal";e.profile={type:a},t.bind("animationend",function(){t.removeClass("rotated-profile-card")}),e.changeProfileType=function(r){t.addClass("rotated-profile-card"),i(function(){e.profile.type=r},500)}}}}]);
app.directive("slideToggle",function(){return{restrict:"A",scope:!0,link:function(e,i,o){var l=parseInt(o.slideToggleDuration,10)||200,n=o.slideToggle;console.log(o.slideToggleShowOnStart),o.slideToggleShowOnStart||$(i).hide(),e.$watch(n,function(e,o){e!==o&&(e?$(i).slideDown(l):$(i).slideUp(l))})}}});
app.directive("spinner",function(){return{restrict:"E",scope:{},template:"<div><md-progress-circular md-mode='indeterminate' md-diameter='96'></md-progress-circular></div>"}});
app.controller("createNewAccountCtrl",["$scope","$mdDialog","authService",function(e,c,n){e.user={},e.hide=function(){c.hide()},e.cancel=function(){c.cancel()},e.answer=function(){n.createNewAccount(e.user).success(function(){c.hide(e.user.first_name+" "+e.user.last_name)}).error(function(){})}}]);
app.controller("ProfileDlgCtrl",["$scope","$mdDialog","uploadFileService","$timeout",function(n,e,i,o){n.close=function(){e.cancel()},n.upload=function(l,c){n.enableSpinner=!0,i(l,"/profile/avatar",c).then(function(){o(function(){n.enableSpinner=!1,e.hide()},1e3)},function(){n.enableSpinner=!1})}}]);
app.controller("AppCtrl",["$scope","socket","$state","authService","$mdDialog",function(o,t,n,i,c){o.logout=function(){i.logout().success(function(){n.go("login")})},t.on("authorization_faild",function(){n.go("login")})}]);
app.controller("LoginCtrl",["$scope","authService","$mdDialog","$state","$mdToast",function(t,e,o,n,c){t.user={},t.login=function(){e.login(t.user).success(function(){n.go("app")}).error(function(t){c.show(c.simple().textContent(t).action("OK").highlightAction(!1).position("top left"))})},t.showAlert=function(t){o.show({controller:"createNewAccountCtrl",templateUrl:"application/modal_dialogs/create_new_account/create_new_account.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0,fullscreen:!0}).then(function(t){c.show(c.simple().textContent(t+" was created").action("OK").highlightAction(!1).position("top left"))})}}]);
app.directive("profileCardGoogle",["$mdDialog","$window","profileService",function(e,r,n){return{restrict:"A",scope:!1,templateUrl:"/application/directives/profile_card/google/google.html",link:function(o,t){function c(){o.isSpinner=!0,n.getProfileInfo("google").success(function(e){console.log(e),o.users=e}).error(function(){})["finally"](function(){o.isSpinner=!1})}o.$watch("users",function(){o.users||(o.currentUser={});var e=o.users.filter(function(e){return e.isCurrent});o.currentUser=e.length?e[0]:{},o.$watch("currentUser",function(){n.updateCurrentGoogleAccount(o.currentUser?o.currentUser.id:-1).success(function(e){}).error(function(){})}),console.log(o.currentUser)}),c(),o.addNewGoogleAccount=function(){r.location.href="/google"},o.selectAvatar=function(){e.show({controller:"ProfileDlgCtrl",templateUrl:"application/modal_dialogs/profile/profile_dlg.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!1,fullscreen:!0,openFrom:angular.element(document.querySelector("#current-user-avatar")),closeTo:angular.element(document.querySelector("#current-user-avatar"))}).then(function(){c()})}}}}]);
app.directive("profileCardInternal",["$mdDialog","profileService",function(e,t){return{restrict:"A",scope:!1,templateUrl:"/application/directives/profile_card/internal/internal.html",link:function(r,n){function o(){t.getProfileInfo("internal").success(function(e){r.user=e,e.birth_date&&(r.user.birthYear=moment(e.birth_date).local().year(),r.user.birthMonth=moment.months(moment(e.birth_date).local().month()),r.user.birthDate=moment(e.birth_date).local().date()),console.log(e)}).error(function(){})}o(),r.selectAvatar=function(){e.show({controller:"ProfileDlgCtrl",templateUrl:"application/modal_dialogs/profile/profile_dlg.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!1,fullscreen:!0,openFrom:angular.element(document.querySelector("#current-user-avatar")),closeTo:angular.element(document.querySelector("#current-user-avatar"))}).then(function(){o()})},r.updateProfile=function(){if(r.user.birthYear&&r.user.birthMonth&&r.user.birthDate){var e=r.user;r.user.birth_date=moment([e.birthDate,e.birthMonth,e.birthYear].join(" ")).format("YYYY-MM-DD")}t.updateInternalProfile(r.user).success(function(){})}}}}]);
app.controller("CalendarCtrl",["$scope","calendarService","uiCalendarConfig","$compile",function(e,n,t,o){e.calendars={google:[]},e.events=[],e.eventSources=[e.events],e.uiConfig={calendar:{height:850,header:{left:"month agendaWeek agendaDay",center:"title",right:"today prev,next"},viewRender:function(t,o){n.getCalendars(moment(t.intervalStart).format("YYYY-MM-DDTHH:mm:ss[Z]"),moment(t.intervalEnd).format("YYYY-MM-DDTHH:mm:ss[Z]")).success(function(n){console.log(n),e.calendars.google=n.google.calendars.items,e.events.splice(0,e.events.length-1),n.google.events.forEach(function(n){e.events.push(n)})})},eventRender:function(n,t,a){console.log("Event Render"),t.attr({tooltip:n.title,"tooltip-append-to-body":!0}),o(t)(e)}}},e.addEvent=function(){e.events.push({title:"Open Sesame",start:new Date,end:new Date})}}]);
app.controller("EmailCtrl",function(){});
app.controller("MessagesCtrl",["$scope","$stateParams","messagesService","$state","messageService",function(e,n,a,t,s){var r=n.labels?n.labels.split(","):["INBOX"];e.threads=[],e.currentPage=1,e.maxPage=1,e.count=50;var o=function(n){e.isSpinner=!0,a.getThreads(r,n).success(function(n){e.nextPageToken=n.nextPageToken,e.threads=e.threads.concat(n.threads),e.threadsCount=n.threadsCount,console.log(n)})["finally"](function(){e.isSpinner=!1})};e.goToPage=function(n){console.log(n),n.back?e.currentPage>1&&e.currentPage--:n.forward&&(e.currentPage<=e.maxPage||e.nextPageToken)&&(e.currentPage==e.maxPage&&(o(e.nextPageToken),e.maxPage=e.currentPage+1),e.currentPage++)},e.toggleLabel=function(e,n){var a=e.labels.indexOf(n);console.log(e),s.toggleThreadLabel(-1==a?[{resource:{addLabelIds:[n],removeLabelIds:[]},id:e.id,userId:"me"}]:[{resource:{removeLabelIds:[n],addLabelIds:[]},id:e.id,userId:"me"}]).success(function(){console.log("Change label",a),-1==a?e.labels.push(n):e.labels.splice(a,1),console.log(e)})},o(),e.refreshData=function(){e.currentPage=1,e.maxPage=1,e.nextPageToken=void 0,e.threads=[],o()},e.tinymceOptions={onChange:function(e){console.log(e)},inline:!1,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks fullscreen media","insertdatetime table contextmenu paste"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",skin:"lightgray",theme:"modern",statusbar:!1,width:450,height:350},e.newMessage={recipients:[],isOpen:!1},e.toggleNewMessage=function(n){e.newMessage.isOpen!==n&&(e.newMessage={recipients:[],isOpen:!1},e.newMessage.isOpen=n)},e.sendMessage=function(){a.sendEmail(e.newMessage).success(function(e){console.log(e)}).error(function(){console.log(arguments)})},e.getSenderOrRecepient=function(e){return-1!=r.indexOf("SENT")?"To: "+e.fromTo.to.map(function(e){var n=e.name?e.name:e.email;return e.count>1?n+" ("+e.count+")":n}).join(", "):e.fromTo.from.map(function(e){var n=e.name?e.name:e.email;return e.count>1?n+" ("+e.count+")":n}).join(", ")},e.grandSelection=function(){e.threads.forEach(function(n){n.isSelected=e.grandSelect})},e.messageSelect=function(){for(var n=0;n<e.threads.length;n++)if(!e.threads[n].isSelected)return void(e.grandSelect=!1);e.grandSelect=!0},e.unreadLabelToggle=function(n){console.log("Unread");var a=e.threads.filter(function(e){return!!e.isSelected});s.toggleThreadLabel(a.map(function(e){return{id:e.id,userId:"me",resource:{addLabelIds:n?["UNREAD"]:[],removeLabelIds:n?[]:["UNREAD"]}}})).success(function(){a.forEach(function(e){e.isSelected=!1;var a=e.labels.indexOf("UNREAD");-1==a&&n?e.labels.push("UNREAD"):-1==a||n||e.labels.splice(a,1)})})},e.removeThreads=function(){a.removeThreads(e.threads.filter(function(e){return!!e.isSelected}).map(function(e){return e.id})).success(function(){e.refreshData()})}}]);
app.controller("ProfileCtrl",["$scope","profileService","$mdDialog","$window","uploadFileService",function(e,o,i,l,r){}]);
app.controller("MessageCtrl",["$scope","$stateParams","messageService",function(e,s,c){c.toggleThreadLabel([{userId:"me",id:s.id,resource:{removeLabelIds:["UNREAD"]}}]).success(function(){}),c.getMessage(s.id).success(function(s){console.log(s),e.thread=s})}]);